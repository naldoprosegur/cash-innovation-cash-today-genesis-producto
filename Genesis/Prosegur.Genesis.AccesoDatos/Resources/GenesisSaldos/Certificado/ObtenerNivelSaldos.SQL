/* GenesisSaldos.Certificado.ObtenerNivelSaldos.SQL */
WITH Q AS (
           SELECT CLICNS.OID_CONFIG_NIVEL_SALDO AS OID_CONFIG_NIVEL_SALDO,
                  CLISALDOS.OID_CLIENTE AS OID_CLIENTE_SALDO,
                  CLISALDOS.COD_CLIENTE AS COD_CLIENTE_SALDO,
                  CLISALDOS.DES_CLIENTE AS DES_CLIENTE_SALDO,
                  SUBSALDOS.OID_SUBCLIENTE AS OID_SUBCLIENTE_SALDO,
                  SUBSALDOS.COD_SUBCLIENTE AS COD_SUBCLIENTE_SALDO,
                  SUBSALDOS.DES_SUBCLIENTE AS DES_SUBCLIENTE_SALDO,
                  PSSALDOS.OID_PTO_SERVICIO AS OID_PTO_SERVICIO_SALDO,
                  PSSALDOS.COD_PTO_SERVICIO AS COD_PTO_SERVICIO_SALDO,
                  PSSALDOS.DES_PTO_SERVICIO AS DES_PTO_SERVICIO_SALDO,
                  cast(CLICNS.GMT_CREACION as date) AS GMT_CREACION_SALDO,
                  CLICNS.DES_USUARIO_CREACION AS DES_USUARIO_CREACION_SALDO,
                  cast(CLICNS.GMT_MODIFICACION as date) AS GMT_MODIFICACION_SALDO,
                  CLICNS.DES_USUARIO_MODIFICACION AS DES_USUARIO_MODIFICACION_SALDO,
                  CLICNM.OID_CONFIG_NIVEL_MOVIMIENTO AS OID_CONFIG_NIVEL_MOVIMIENTO,
                  CLIMOV.OID_CLIENTE AS OID_CLIENTE_MOVIMIENTO,
                  CLIMOV.COD_CLIENTE AS COD_CLIENTE_MOVIMIENTO,
                  CLIMOV.DES_CLIENTE AS DES_CLIENTE_MOVIMIENTO,
                  SUBMOV.OID_SUBCLIENTE AS OID_SUBCLIENTE_MOVIMIENTO,
                  SUBMOV.COD_SUBCLIENTE AS COD_SUBCLIENTE_MOVIMIENTO,
                  SUBMOV.DES_SUBCLIENTE AS DES_SUBCLIENTE_MOVIMIENTO,
                  PSMOV.OID_PTO_SERVICIO AS OID_PTO_SERVICIO_MOVIMIENTO,
                  PSMOV.COD_PTO_SERVICIO AS COD_PTO_SERVICIO_MOVIMIENTO,
                  PSMOV.DES_PTO_SERVICIO AS DES_PTO_SERVICIO_MOVIMIENTO,
                  SUBCMOV.OID_SUBCANAL AS OID_SUBCANAL_MOVIMIENTO,
                  SUBCMOV.COD_SUBCANAL AS COD_SUBCANAL_MOVIMIENTO,
                  SUBCMOV.DES_SUBCANAL AS DES_SUBCANAL_MOVIMIENTO,
                  CLICNM.FYH_VIGENCIA AS FYH_VIGENCIA_MOVIMIENTO,
                  CLICNM.BOL_ACTIVO AS BOL_ACTIVO_MOVIMIENTO,
                  cast(CLICNM.GMT_CREACION as date) AS GMT_CREACION_MOVIMIENTO,
                  CLICNM.DES_USUARIO_CREACION AS DES_USUARIO_CREAC_MOVIMIENTO,
                  cast(CLICNM.GMT_MODIFICACION as date) AS GMT_MODIFICACION_MOVIMIENTO,
                  CLICNM.DES_USUARIO_MODIFICACION AS DES_USUARIO_MOD_MOVIMIENTO
                  ,CASE CLISALDOS.COD_CLIENTE
                    WHEN []COD_CLIENTE THEN
                     1
                    ELSE
                     0
                  END AS ES_TOTALIZADOR,
                  CLICNM.OID_CLIENTE AS OID_CLIENTE, 
                  CLICNM.OID_SUBCANAL AS OID_SUBCANAL, 
                  CLICNM.OID_PTO_SERVICIO AS OID_PTO_SERVICIO,
                  CLICNM.OID_SUBCLIENTE AS OID_SUBCLIENTE 
             FROM SAPR_TCONFIG_NIVEL_MOVIMIENTO CLICNM
            INNER JOIN SAPR_TCONFIG_NIVEL_SALDO CLICNS 
               ON CLICNM.OID_CONFIG_NIVEL_SALDO = CLICNS.OID_CONFIG_NIVEL_SALDO
            INNER JOIN GEPR_TCLIENTE CLISALDOS 
               ON CLISALDOS.OID_CLIENTE = CLICNS.OID_CLIENTE
             LEFT JOIN GEPR_TSUBCLIENTE SUBSALDOS 
               ON SUBSALDOS.OID_SUBCLIENTE = CLICNS.OID_SUBCLIENTE
             LEFT JOIN GEPR_TPUNTO_SERVICIO PSSALDOS 
               ON PSSALDOS.OID_PTO_SERVICIO = CLICNS.OID_PTO_SERVICIO
            INNER JOIN GEPR_TCLIENTE CLIMOV 
               ON CLIMOV.OID_CLIENTE = CLICNM.OID_CLIENTE
             LEFT JOIN GEPR_TSUBCLIENTE SUBMOV 
               ON SUBMOV.OID_SUBCLIENTE = CLICNM.OID_SUBCLIENTE
             LEFT JOIN GEPR_TPUNTO_SERVICIO PSMOV 
               ON PSMOV.OID_PTO_SERVICIO = CLICNM.OID_PTO_SERVICIO
             LEFT JOIN GEPR_TSUBCANAL SUBCMOV 
               ON SUBCMOV.OID_SUBCANAL = CLICNM.OID_SUBCANAL
            WHERE SUBCMOV.COD_SUBCANAL IN ([]COD_SUBCANAL) 
              AND CLICNM.BOL_ACTIVO = 1
            UNION
           SELECT CLICNS.OID_CONFIG_NIVEL_SALDO AS OID_CONFIG_NIVEL_SALDO,
                  CLISALDOS.OID_CLIENTE AS OID_CLIENTE_SALDO,
                  CLISALDOS.COD_CLIENTE AS COD_CLIENTE_SALDO,
                  CLISALDOS.DES_CLIENTE AS DES_CLIENTE_SALDO,
                  SUBSALDOS.OID_SUBCLIENTE AS OID_SUBCLIENTE_SALDO,
                  SUBSALDOS.COD_SUBCLIENTE AS COD_SUBCLIENTE_SALDO,
                  SUBSALDOS.DES_SUBCLIENTE AS DES_SUBCLIENTE_SALDO,
                  PSSALDOS.OID_PTO_SERVICIO AS OID_PTO_SERVICIO_SALDO,
                  PSSALDOS.COD_PTO_SERVICIO AS COD_PTO_SERVICIO_SALDO,
                  PSSALDOS.DES_PTO_SERVICIO AS DES_PTO_SERVICIO_SALDO,
                  CAST(CLICNS.GMT_CREACION AS DATE) AS GMT_CREACION_SALDO,
                  CLICNS.DES_USUARIO_CREACION AS DES_USUARIO_CREACION_SALDO,
                  CAST(CLICNS.GMT_MODIFICACION AS DATE) AS GMT_MODIFICACION_SALDO,
                  CLICNS.DES_USUARIO_MODIFICACION AS DES_USUARIO_MODIFICACION_SALDO,
                  CLICNM.OID_CONFIG_NIVEL_MOVIMIENTO AS OID_CONFIG_NIVEL_MOVIMIENTO,
                  CLIMOV.OID_CLIENTE AS OID_CLIENTE_MOVIMIENTO,
                  CLIMOV.COD_CLIENTE AS COD_CLIENTE_MOVIMIENTO,
                  CLIMOV.DES_CLIENTE AS DES_CLIENTE_MOVIMIENTO,
                  SUBMOV.OID_SUBCLIENTE AS OID_SUBCLIENTE_MOVIMIENTO,
                  SUBMOV.COD_SUBCLIENTE AS COD_SUBCLIENTE_MOVIMIENTO,
                  SUBMOV.DES_SUBCLIENTE AS DES_SUBCLIENTE_MOVIMIENTO,
                  PSMOV.OID_PTO_SERVICIO AS OID_PTO_SERVICIO_MOVIMIENTO,
                  PSMOV.COD_PTO_SERVICIO AS COD_PTO_SERVICIO_MOVIMIENTO,
                  PSMOV.DES_PTO_SERVICIO AS DES_PTO_SERVICIO_MOVIMIENTO,
                  SUBCMOV.OID_SUBCANAL AS OID_SUBCANAL_MOVIMIENTO,
                  SUBCMOV.COD_SUBCANAL AS COD_SUBCANAL_MOVIMIENTO,
                  SUBCMOV.DES_SUBCANAL AS DES_SUBCANAL_MOVIMIENTO,
                  CLICNM.FYH_VIGENCIA AS FYH_VIGENCIA_MOVIMIENTO,
                  CLICNM.BOL_ACTIVO AS BOL_ACTIVO_MOVIMIENTO,
                  CAST(CLICNM.GMT_CREACION AS DATE) AS GMT_CREACION_MOVIMIENTO,
                  CLICNM.DES_USUARIO_CREACION AS DES_USUARIO_CREAC_MOVIMIENTO,
                  CAST(CLICNM.GMT_MODIFICACION AS DATE) AS GMT_MODIFICACION_MOVIMIENTO,
                  CLICNM.DES_USUARIO_MODIFICACION AS DES_USUARIO_MOD_MOVIMIENTO
                  ,CASE CLISALDOS.COD_CLIENTE
                    WHEN []COD_CLIENTE THEN
                     1
                    ELSE
                     0
                  END AS ES_TOTALIZADOR,
                  CLICNM.OID_CLIENTE AS OID_CLIENTE,
                  CLICNM.OID_SUBCANAL AS OID_SUBCANAL,
                  CLICNM.OID_PTO_SERVICIO AS OID_PTO_SERVICIO,
                  CLICNM.OID_SUBCLIENTE AS OID_SUBCLIENTE
             FROM SAPR_TCONFIG_NIVEL_MOVIMIENTO CLICNM
            INNER JOIN SAPR_TCONFIG_NIVEL_SALDO CLICNS 
               ON CLICNM.OID_CONFIG_NIVEL_SALDO = CLICNS.OID_CONFIG_NIVEL_SALDO
            INNER JOIN GEPR_TCLIENTE CLISALDOS 
               ON CLISALDOS.OID_CLIENTE = CLICNS.OID_CLIENTE
             LEFT JOIN GEPR_TSUBCLIENTE SUBSALDOS 
               ON SUBSALDOS.OID_SUBCLIENTE = CLICNS.OID_SUBCLIENTE
             LEFT JOIN GEPR_TPUNTO_SERVICIO PSSALDOS 
               ON PSSALDOS.OID_PTO_SERVICIO = CLICNS.OID_PTO_SERVICIO
            INNER JOIN GEPR_TCLIENTE CLIMOV 
               ON CLIMOV.OID_CLIENTE = CLICNM.OID_CLIENTE
             LEFT JOIN GEPR_TSUBCLIENTE SUBMOV 
               ON SUBMOV.OID_SUBCLIENTE = CLICNM.OID_SUBCLIENTE
             LEFT JOIN GEPR_TPUNTO_SERVICIO PSMOV 
               ON PSMOV.OID_PTO_SERVICIO = CLICNM.OID_PTO_SERVICIO
             LEFT JOIN GEPR_TSUBCANAL SUBCMOV 
               ON SUBCMOV.OID_SUBCANAL = CLICNM.OID_SUBCANAL
            WHERE SUBCMOV.COD_SUBCANAL IS NULL
              AND CLICNM.BOL_ACTIVO = 1
          )
SELECT Q.OID_CONFIG_NIVEL_SALDO,
       Q.OID_CLIENTE_SALDO,
       Q.COD_CLIENTE_SALDO,
       Q.DES_CLIENTE_SALDO,
       Q.OID_SUBCLIENTE_SALDO,
       Q.COD_SUBCLIENTE_SALDO,
       Q.DES_SUBCLIENTE_SALDO,
       Q.OID_PTO_SERVICIO_SALDO,
       Q.COD_PTO_SERVICIO_SALDO,
       Q.DES_PTO_SERVICIO_SALDO,
       Q.GMT_CREACION_SALDO,
       Q.DES_USUARIO_CREACION_SALDO,
       Q.GMT_MODIFICACION_SALDO,
       Q.DES_USUARIO_MODIFICACION_SALDO,
       Q.OID_CONFIG_NIVEL_MOVIMIENTO,
       Q.OID_CLIENTE_MOVIMIENTO,
       Q.COD_CLIENTE_MOVIMIENTO,
       Q.DES_CLIENTE_MOVIMIENTO,
       Q.OID_SUBCLIENTE_MOVIMIENTO,
       Q.COD_SUBCLIENTE_MOVIMIENTO,
       Q.DES_SUBCLIENTE_MOVIMIENTO,
       Q.OID_PTO_SERVICIO_MOVIMIENTO,
       Q.COD_PTO_SERVICIO_MOVIMIENTO,
       Q.DES_PTO_SERVICIO_MOVIMIENTO,
       Q.OID_SUBCANAL_MOVIMIENTO,
       Q.COD_SUBCANAL_MOVIMIENTO,
       Q.DES_SUBCANAL_MOVIMIENTO,
       Q.FYH_VIGENCIA_MOVIMIENTO,
       Q.BOL_ACTIVO_MOVIMIENTO,
       Q.GMT_CREACION_MOVIMIENTO,
       Q.DES_USUARIO_CREAC_MOVIMIENTO,
       Q.GMT_MODIFICACION_MOVIMIENTO,
       Q.DES_USUARIO_MOD_MOVIMIENTO,
       Q.ES_TOTALIZADOR
  FROM Q
 WHERE EXISTS (
               SELECT CNM.OID_CLIENTE
                  FROM SAPR_TCONFIG_NIVEL_SALDO CNS
                 INNER JOIN SAPR_TCONFIG_NIVEL_MOVIMIENTO CNM 
                    ON CNS.OID_CONFIG_NIVEL_SALDO = CNM.OID_CONFIG_NIVEL_SALDO
                 INNER JOIN GEPR_TCLIENTE CLI 
                    ON CLI.OID_CLIENTE = CNS.OID_CLIENTE
                  LEFT JOIN GEPR_TSUBCANAL SUBC 
                    ON SUBC.OID_SUBCANAL = CNM.OID_SUBCANAL
                 WHERE Q.OID_CLIENTE = CNM.OID_CLIENTE
                   AND CLI.COD_CLIENTE = []COD_CLIENTE
                   AND (SUBC.COD_SUBCANAL IN ([]COD_SUBCANAL) OR SUBC.COD_SUBCANAL IS NULL)
                   AND CNM.BOL_ACTIVO = 1)
   AND NOT EXISTS (
                   SELECT CNM.OID_CLIENTE
                     FROM SAPR_TCONFIG_NIVEL_SALDO CNS
                    INNER JOIN SAPR_TCONFIG_NIVEL_MOVIMIENTO CNM 
                       ON CNS.OID_CONFIG_NIVEL_SALDO = CNM.OID_CONFIG_NIVEL_SALDO
                    INNER JOIN GEPR_TCLIENTE CLI 
                       ON CLI.OID_CLIENTE = CNS.OID_CLIENTE
                    INNER JOIN GEPR_TSUBCANAL SUBC 
                       ON SUBC.OID_SUBCANAL = CNM.OID_SUBCANAL
                    WHERE Q.OID_CLIENTE = CNM.OID_CLIENTE
                      AND (NVL(Q.OID_SUBCLIENTE,'1') = NVL(CNM.OID_SUBCLIENTE,'1') )
                      AND (NVL(Q.OID_PTO_SERVICIO,'1') = NVL(CNM.OID_PTO_SERVICIO,'1') )
                      AND CLI.COD_CLIENTE != []COD_CLIENTE
                      AND CNM.BOL_ACTIVO = 1
                      AND SUBC.COD_SUBCANAL IN ([]COD_SUBCANAL)
                      AND Q.OID_SUBCANAL IS NULL
                  )
   AND NOT EXISTS (
                   SELECT CNM.OID_CLIENTE
                     FROM SAPR_TCONFIG_NIVEL_SALDO CNS
                    INNER JOIN SAPR_TCONFIG_NIVEL_MOVIMIENTO CNM 
                       ON CNS.OID_CONFIG_NIVEL_SALDO = CNM.OID_CONFIG_NIVEL_SALDO
                    INNER JOIN GEPR_TCLIENTE CLI 
                       ON CLI.OID_CLIENTE = CNS.OID_CLIENTE
                    INNER JOIN GEPR_TSUBCANAL SUBC 
                       ON SUBC.OID_SUBCANAL = CNM.OID_SUBCANAL
                    WHERE Q.OID_CLIENTE = CNM.OID_CLIENTE
                      AND (NVL(Q.OID_SUBCLIENTE,'1') = NVL(CNM.OID_SUBCLIENTE,'1') )
                      AND (NVL(Q.OID_PTO_SERVICIO,'1') = NVL(CNM.OID_PTO_SERVICIO,'1') )
                      AND CLI.COD_CLIENTE = []COD_CLIENTE
                      AND CNM.BOL_ACTIVO = 1
                      AND SUBC.COD_SUBCANAL IN ([]COD_SUBCANAL)
                      AND Q.OID_SUBCANAL IS NULL
                  )