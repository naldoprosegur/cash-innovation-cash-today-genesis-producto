CREATE OR REPLACE PROCEDURE SP_PLANIFICACIONES
(
   P_PLANO   IN  VARCHAR2,
   P_RETORNO OUT SYS_REFCURSOR
)IS
BEGIN
  BEGIN
    OPEN P_RETORNO FOR
      SELECT
        DISTINCT
        --DELEGAÇÃO
        SUBSTR(DEL.COD_DELEGACION,3,8) AS COD_DELEGACAO, DEL.DES_DELEGACION AS NOME_DELEGACAO,
        --SECTOR
        SEC.COD_SECTOR, SEC.DES_SECTOR, CA_SECTOR.COD_AJENO COD_AJENO_SECTOR, CA_SECTOR.DES_AJENO DES_AJENO_SECTOR,
        CASE WHEN SEC.BOL_ACTIVO = 1 THEN 'SIM' ELSE 'NAO' END AS SETOR_ATIVO,
        MDL.COD_MODELO||' - '||MDL.DES_MODELO AS MODELO,
        --CLIENTE
        CA_CLIENTE.COD_AJENO COD_AJENO_CLIENTE, CA_CLIENTE.DES_AJENO DES_AJENO_CLIENTE,
        C.COD_CLIENTE, C.DES_CLIENTE, CASE WHEN C.BOL_VIGENTE = 1 THEN 'SIM' ELSE 'NAO' END AS CLIENTE_ATIVO,
        --SUBCLIENTE
        CA_SUB.COD_AJENO COD_AJENO_SUB, CA_SUB.DES_AJENO DES_AJENO_SUB,
        SC.COD_SUBCLIENTE, SC.DES_SUBCLIENTE, CASE WHEN SC.BOL_VIGENTE = 1 THEN 'SIM' ELSE 'NAO' END AS SUBCLIENTE_ATIVO,
        --PONTO
        CA_PONTO.COD_AJENO COD_AJENO_PONTO, CA_PONTO.DES_AJENO DES_AJENO_PONTO,
        TO_CHAR(CA_PONTO.GMT_MODIFICACION,'DD/MM/YYYY HH24:MI:SS') AS DATA_ALT_PTO_AJENO,
        PS.COD_PTO_SERVICIO, PS.DES_PTO_SERVICIO, TO_CHAR(PS.FYH_ACTUALIZACION,'DD/MM/YYYY HH24:MI:SS') AS DATA_ALT_PTO,
        CASE WHEN PS.BOL_VIGENTE = 1 THEN 'SIM' ELSE 'NAO' END AS PONTO_ATIVO,
        --PLANIFICAÇÃO
        CASE WHEN PLA.COD_PLANIFICACION IS NULL THEN 'SEM PLANIFICACAO' ELSE PLA.COD_PLANIFICACION END AS COD_PLANIFICACAO,
        CASE WHEN PLA.DES_PLANIFICACION IS NULL THEN 'SEM PLANIFICACAO' ELSE PLA.DES_PLANIFICACION END AS DES_PLANIFICACAO,
        CASE WHEN PXM.BOL_ACTIVO = 1 THEN 'SIM' ELSE 'NAO' END AS MAE_PLAN_ATIVA,
        CASE WHEN PLA.FYH_VIGENCIA_INICIO IS NULL THEN 'N/C' ELSE TO_CHAR(PLA.FYH_VIGENCIA_INICIO,'DD/MM/YYYY HH24:MI:SS') END AS DT_INI_VIG_PLANIFICACAO,
        CASE WHEN PLA.FYH_VIGENCIA_FIN IS NULL THEN 'N/C' ELSE TO_CHAR(PLA.FYH_VIGENCIA_FIN,'DD/MM/YYYY HH24:MI:SS') END AS DT_FIM_VIG_PLANIFICACAO,
        CASE WHEN PLA.NEC_CONTINGENCIA IS NULL THEN 'N/C' ELSE TO_CHAR(PLA.NEC_CONTINGENCIA) END AS MIN_CONTIGENCIA,
        CASE WHEN C_DB.COD_CLIENTE IS NULL THEN 'N/C' ELSE C_DB.COD_CLIENTE END AS BANCO,
        CASE WHEN C_DB.DES_CLIENTE IS NULL THEN 'N/C' ELSE C_DB.DES_CLIENTE END AS NOME_BANCO,
        CASE WHEN DB.COD_CUENTA_BANCARIA IS NULL THEN 'N/C' ELSE DB.COD_CUENTA_BANCARIA END AS CONTA_BANCARIA
  FROM RPGE_YMAQUINA MAE
  INNER JOIN RPGE_YSECTOR SEC ON SEC.OID_SECTOR = MAE.OID_SECTOR
  INNER JOIN RPGE_YPLANTA PLAT ON PLAT.OID_PLANTA = SEC.OID_PLANTA
  INNER JOIN RPGE_YDELEGACION DEL ON DEL.OID_DELEGACION = PLAT.OID_DELEGACION
  INNER JOIN RPGE_YCODIGO_AJENO CA_SEC ON CA_SEC.OID_TABLA_GENESIS = SEC.OID_SECTOR
  INNER JOIN RPGE_YMODELO MDL ON MDL.OID_MODELO = MAE.OID_MODELO
  LEFT JOIN RPGE_YPLANXMAQUINA PXM ON PXM.OID_MAQUINA = MAE.OID_MAQUINA
  LEFT JOIN RPGE_YPLANIFICACION PLA ON PLA.OID_PLANIFICACION = PXM.OID_PLANIFICACION
  INNER JOIN RPGE_YCODIGO_AJENO CA_SECTOR ON CA_SECTOR.OID_TABLA_GENESIS = SEC.OID_SECTOR
  LEFT JOIN RPGE_YCODIGO_AJENO CA_CLIENTE ON CA_CLIENTE.COD_AJENO = SUBSTR(CA_SECTOR.COD_AJENO,6,6)
  LEFT JOIN RPGE_YCLIENTE C ON CA_CLIENTE.OID_TABLA_GENESIS = C.OID_CLIENTE
  LEFT JOIN RPGE_YCODIGO_AJENO CA_SUB ON CA_SUB.COD_AJENO = SUBSTR(CA_SECTOR.COD_AJENO,6,6)||'-'||
                                                                    SUBSTR(CA_SECTOR.COD_AJENO,12,4)
  LEFT JOIN RPGE_YSUBCLIENTE SC ON SC.OID_SUBCLIENTE = CA_SUB.OID_TABLA_GENESIS
  LEFT JOIN RPGE_YCODIGO_AJENO  CA_PONTO ON CA_PONTO.COD_AJENO =  SUBSTR(CA_SECTOR.COD_AJENO,6,6)||'-'||
                                                                         SUBSTR(CA_SECTOR.COD_AJENO,12,4)||'-'||
                                                                         SUBSTR(CA_SECTOR.COD_AJENO,16,2)
  LEFT JOIN RPGE_YPUNTO_SERVICIO PS ON PS.OID_PTO_SERVICIO = CA_PONTO.OID_TABLA_GENESIS
  LEFT JOIN RPGE_YDATO_BANCARIO DB ON DB.OID_PTO_SERVICIO = PS.OID_PTO_SERVICIO
  LEFT JOIN RPGE_YCLIENTE C_DB ON C_DB.OID_CLIENTE = DB.OID_BANCO
  WHERE 1=1
  AND (
      (P_PLANO = 'NAO' AND PLA.COD_PLANIFICACION IS NULL)
       OR
      (P_PLANO = 'SIM' AND PLA.COD_PLANIFICACION IS NOT NULL)
       OR
      (P_PLANO = 'TODOS' AND (PLA.COD_PLANIFICACION IS NULL OR PLA.COD_PLANIFICACION IS NOT NULL))
      )
  ORDER BY
        SUBSTR(DEL.COD_DELEGACION,3,8), C.COD_CLIENTE, SC.COD_SUBCLIENTE, PS.COD_PTO_SERVICIO;
  END;
END SP_PLANIFICACIONES;
/