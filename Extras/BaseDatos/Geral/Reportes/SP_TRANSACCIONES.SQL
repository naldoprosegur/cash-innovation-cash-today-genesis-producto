CREATE OR REPLACE PROCEDURE SP_TRANSACCIONES
(
   P_DATA_INI_TRANSAC IN TIMESTAMP,
   P_DATA_FIM_TRANSAC IN TIMESTAMP,
   P_DATA_INI_VALID   IN TIMESTAMP,
   P_DATA_FIM_VALID   IN TIMESTAMP,
   P_DATA_INI_SISTEMA IN TIMESTAMP,
   P_DATA_FIM_SISTEMA IN TIMESTAMP,
   P_DEVICEID         IN VARCHAR2,
   P_TIPO             IN VARCHAR2,
   P_D0               IN VARCHAR2,
   P_RETORNO          OUT SYS_REFCURSOR
)IS
--V_OID_CUENTA       VARCHAR2(100);
V_DES_ZONA         VARCHAR2(100);
V_DATA_INI_TRANSAC TIMESTAMP;
V_DATA_FIM_TRANSAC TIMESTAMP;
V_DATA_INI_VALID   TIMESTAMP;
V_DATA_FIM_VALID   TIMESTAMP;
V_DATA_INI_SISTEMA TIMESTAMP;
V_DATA_FIM_SISTEMA TIMESTAMP;
BEGIN

--AJUSTE PARA O WHERE
IF P_DEVICEID IS NOT NULL THEN
  SELECT DISTINCT D.DES_ZONA INTO V_DES_ZONA
  FROM RPGE_YVCUENTA CUE
  INNER JOIN RPGE_YDELEGACION D ON D.COD_DELEGACION = CUE.COD_DELEGACION
  WHERE 1=1
  AND D.BOL_VIGENTE = 1
  AND CUE.COD_CANAL IN ('ING','DEB')
  AND CUE.COD_SECTOR LIKE '%'||P_DEVICEID;
  IF V_DES_ZONA = 'SUDESTE' OR V_DES_ZONA = 'CENTRO OESTE' OR V_DES_ZONA = 'SUL' THEN
    V_DATA_INI_TRANSAC := P_DATA_INI_TRANSAC+3/24;
    V_DATA_FIM_TRANSAC := P_DATA_FIM_TRANSAC+3/24;
    V_DATA_INI_SISTEMA := P_DATA_INI_SISTEMA+3/24;
    V_DATA_FIM_SISTEMA := (P_DATA_FIM_SISTEMA+1/1440/60)+3/24;
    V_DATA_INI_VALID   := TO_CHAR(P_DATA_INI_VALID+2/24,'DD/MM/YYYY HH24:MI:SS');
    V_DATA_FIM_VALID   := TO_CHAR(P_DATA_FIM_VALID+2/24,'DD/MM/YYYY HH24:MI:SS');
    ELSE
      V_DATA_INI_TRANSAC := P_DATA_INI_TRANSAC+3/24;
      V_DATA_FIM_TRANSAC := P_DATA_FIM_TRANSAC+3/24;
      V_DATA_INI_SISTEMA := P_DATA_INI_SISTEMA+3/24;
      V_DATA_FIM_SISTEMA := (P_DATA_FIM_SISTEMA+1/1440/60)+3/24;
      V_DATA_INI_VALID   := TO_CHAR(P_DATA_INI_VALID+2/24,'DD/MM/YYYY HH24:MI:SS');
      V_DATA_FIM_VALID   := TO_CHAR(P_DATA_FIM_VALID+2/24,'DD/MM/YYYY HH24:MI:SS');
  END IF;
ELSE
  V_DATA_INI_TRANSAC := P_DATA_INI_TRANSAC+3/24;
  V_DATA_FIM_TRANSAC := P_DATA_FIM_TRANSAC+3/24;
  V_DATA_INI_SISTEMA := P_DATA_INI_SISTEMA+3/24;
  V_DATA_FIM_SISTEMA := (P_DATA_FIM_SISTEMA+1/1440/60)+3/24;
  V_DATA_INI_VALID   := TO_CHAR(P_DATA_INI_VALID+2/24,'DD/MM/YYYY HH24:MI:SS');
  V_DATA_FIM_VALID   := TO_CHAR(P_DATA_FIM_VALID+2/24,'DD/MM/YYYY HH24:MI:SS');
END IF;
/*
DBMS_OUTPUT.PUT_LINE(V_DES_ZONA);
DBMS_OUTPUT.PUT_LINE('TRANS '||P_DATA_INI_TRANSAC||' - '||P_DATA_FIM_TRANSAC);
DBMS_OUTPUT.PUT_LINE('TRANS '||V_DATA_INI_TRANSAC||' - '||V_DATA_FIM_TRANSAC);
DBMS_OUTPUT.PUT_LINE('VALID '||P_DATA_INI_VALID||' - '||P_DATA_FIM_VALID);
DBMS_OUTPUT.PUT_LINE('VALID '||V_DATA_INI_VALID||' - '||V_DATA_FIM_VALID);
DBMS_OUTPUT.PUT_LINE('SISTE '||P_DATA_INI_SISTEMA||' - '||P_DATA_FIM_SISTEMA);
DBMS_OUTPUT.PUT_LINE('SISTE '||V_DATA_INI_SISTEMA||' - '||V_DATA_FIM_SISTEMA);
*/
  BEGIN
    OPEN P_RETORNO FOR
      SELECT * FROM (
        SELECT DISTINCT
          CUE.DES_DELEGACION AS FILIAL,
          SUBSTR(DOC.COD_EXTERNO,0,LENGTH(DOC.COD_EXTERNO) - 2) AS COD_TRANSACAO,
          SUBSTR(CUE.COD_SECTOR,6,17) AS DEVICEID,
          CUE.DES_PTO_SERVICIO AS NOME_DA_MAE,
          --VERIFICA DELEGACAO É E FAZ A CONVERSÃO PARA DATA TRANSAÇÃO E DATA CRIACAO NO GENESIS
          CASE
             WHEN DEL_MAE.DES_ZONA IN ('SUDESTE','CENTRO OESTE','SUL')
               THEN
                 (CASE WHEN DOC.FYH_GESTION BETWEEN DEL_MAE.FYH_VERANO_INICIO AND DEL_MAE.FYH_VERANO_FIN
                       THEN TO_CHAR(FN_GMT_DELEGACION(CUE.OID_DELEGACION, DOC.FYH_GESTION-1/24),'DD/MM/YYYY HH24:MI:SS')
                       ELSE TO_CHAR(FN_GMT_DELEGACION(CUE.OID_DELEGACION, DOC.FYH_GESTION),'DD/MM/YYYY HH24:MI:SS')
                  END)
             ELSE TO_CHAR(FN_GMT_DELEGACION(CUE.OID_DELEGACION, DOC.FYH_GESTION),'DD/MM/YYYY HH24:MI:SS')
           END AS DATA_DA_TRANSACAO,
           CASE
             WHEN DEL_MAE.DES_ZONA IN ('SUDESTE','CENTRO OESTE','SUL')
               THEN
                 (CASE WHEN DOC.GMT_CREACION BETWEEN DEL_MAE.FYH_VERANO_INICIO AND DEL_MAE.FYH_VERANO_FIN
                       THEN TO_CHAR(FN_GMT_DELEGACION(CUE.OID_DELEGACION, DOC.GMT_CREACION),'DD/MM/YYYY HH24:MI:SS')
                       ELSE TO_CHAR(FN_GMT_DELEGACION(CUE.OID_DELEGACION, DOC.GMT_CREACION+1/24),'DD/MM/YYYY HH24:MI:SS')
                  END)
             ELSE TO_CHAR(FN_GMT_DELEGACION(CUE.OID_DELEGACION, DOC.GMT_CREACION),'DD/MM/YYYY HH24:MI:SS')
           END AS DATA_DA_CRIACAO_NO_SALDOS,
           --VERIFICA A DATA DO CREDITO
           CASE
             WHEN PE.OID_ACREDITACION IS NOT NULL
               THEN
                 (CASE WHEN DEL_PLA.DES_ZONA IN ('SUDESTE','CENTRO OESTE','SUL')
                         THEN
                           (CASE
                              WHEN ACR.FYH_ACREDITACION BETWEEN DEL_PLA.FYH_VERANO_INICIO AND DEL_PLA.FYH_VERANO_FIN
                              THEN TO_CHAR(FN_GMT_DELEGACION(PLA.OID_DELEGACION, ACR.FYH_ACREDITACION),'DD/MM/YYYY HH24:MI:SS')
                              ELSE TO_CHAR(FN_GMT_DELEGACION(PLA.OID_DELEGACION, ACR.FYH_ACREDITACION+1/24),'DD/MM/YYYY HH24:MI:SS')
                            END)
                  ELSE TO_CHAR(FN_GMT_DELEGACION(PLA.OID_DELEGACION, ACR.FYH_ACREDITACION),'DD/MM/YYYY HH24:MI:SS')
                  END)
           ELSE 'NÃO INFORMADO AO CLIENTE' END DATA_CREDITO,
           CASE WHEN CUE.COD_CANAL = 'DEB' THEN 'DECLARADO' ELSE 'CONTADO' END TIPO_DE_DEPOSITO,
           SUM(TE.NUM_IMPORTE) AS VALOR_IMPORTE
        FROM RPGE_YMAQUINA MAE
        INNER JOIN RPGE_YVCUENTA CUE ON CUE.OID_SECTOR = MAE.OID_SECTOR
        INNER JOIN RPGE_YDOCUMENTO DOC ON DOC.OID_CUENTA_ORIGEN = CUE.OID_CUENTA
        INNER JOIN RPGE_YTRANSACCION_EFECTIVO TE ON TE.OID_DOCUMENTO = DOC.OID_DOCUMENTO
        INNER JOIN RPGE_YDELEGACION DEL_MAE ON DEL_MAE.OID_DELEGACION = CUE.OID_DELEGACION
        LEFT JOIN RPGE_YPLANXMAQUINA PXM ON PXM.OID_MAQUINA = MAE.OID_MAQUINA
        LEFT JOIN RPGE_YPERIODOXDOCUMENTO PD ON PD.OID_DOCUMENTO = DOC.OID_DOCUMENTO
        LEFT JOIN RPGE_YPERIODO PE ON PE.OID_PERIODO = PD.OID_PERIODO
        LEFT JOIN RPGE_YACREDITACION ACR ON ACR.OID_ACREDITACION = PE.OID_ACREDITACION
        LEFT JOIN RPGE_YPLANIFICACION PLA ON PLA.OID_PLANIFICACION = PXM.OID_PLANIFICACION
        LEFT JOIN RPGE_YDELEGACION DEL_PLA ON DEL_PLA.OID_DELEGACION = PLA.OID_DELEGACION
        WHERE 1=1
        AND CUE.COD_CANAL IN ('ING','DEB')
        AND DOC.COD_ESTADO = 'AC'
        --SE TEM OU NAO DEVICEID
        AND (P_DEVICEID IS NULL OR CUE.OID_CUENTA IN (SELECT CUE.OID_CUENTA
                                                      FROM RPGE_YVCUENTA CUE
                                                      INNER JOIN RPGE_YDELEGACION D ON D.COD_DELEGACION = CUE.COD_DELEGACION
                                                      WHERE 1=1
                                                      AND D.BOL_VIGENTE = 1
                                                      AND CUE.COD_CANAL IN ('ING','DEB')
                                                      AND CUE.COD_SECTOR LIKE '%'||P_DEVICEID)
            )
        --QUAL A DATA QUE ESTA SENDO USADA
        AND ((DOC.FYH_GESTION BETWEEN V_DATA_INI_TRANSAC AND V_DATA_FIM_TRANSAC)
              OR
             (ACR.FYH_ACREDITACION BETWEEN V_DATA_INI_VALID AND V_DATA_FIM_VALID)
              OR
             (SYS_EXTRACT_UTC(DOC.GMT_CREACION) BETWEEN V_DATA_INI_SISTEMA AND V_DATA_FIM_SISTEMA)
            )
        --FILTRA SE É DEPOSITO, COLETA OU TODOS
        AND (
             (P_TIPO = 'DEPOSITO' AND DOC.COD_EXTERNO LIKE '%CASHIN%')
              OR
             (P_TIPO = 'COLETA' AND DOC.COD_EXTERNO LIKE '%SHIPOUT%')
              OR
             (P_TIPO = 'TODOS' AND DOC.COD_EXTERNO IS NOT NULL)
            )
        --FILTRO PARA SABER SE A MAE É D0 OU NÃO
        AND (
             (P_D0 = 'SIM' AND PLA.OID_PLANIFICACION IS NOT NULL)
              OR
             (P_D0 = 'NAO' AND PLA.OID_PLANIFICACION IS NULL)
              OR
             (P_D0 = 'TODOS' AND (PLA.OID_PLANIFICACION IS NULL OR PLA.OID_PLANIFICACION IS NOT NULL))
            )
        GROUP BY
           CUE.DES_DELEGACION, DOC.COD_EXTERNO, CUE.COD_SECTOR, CUE.DES_PTO_SERVICIO, CUE.COD_CANAL,
           DEL_MAE.DES_ZONA, CUE.OID_DELEGACION, DOC.FYH_GESTION, DOC.GMT_CREACION,
           PE.OID_ACREDITACION, PLA.OID_DELEGACION, ACR.FYH_ACREDITACION, DOC.COD_ESTADO,
           DEL_MAE.FYH_VERANO_INICIO, DEL_MAE.FYH_VERANO_FIN, DEL_PLA.FYH_VERANO_INICIO, DEL_PLA.FYH_VERANO_FIN,
           DEL_PLA.OID_DELEGACION,DEL_PLA.DES_ZONA
        )
      ORDER BY FILIAL, DEVICEID, NOME_DA_MAE ASC, DATA_DA_TRANSACAO, DATA_CREDITO DESC;
  END;
END SP_TRANSACCIONES;
/